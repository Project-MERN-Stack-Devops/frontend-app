name: Deploy Frontend 

env:
 BACKEND_PATH_ARGS: --build-arg VITE_API_URL=https://api.33.lebondeveloppeur.net
 IMAGE_NAME:  adeem07/app-session14
 DOCKER_COMPOSE_FILE_PATH : /home/user/devops-script/frontend/dev 
 SERVICE_NAME_FRONTEND : frontend-app 
on:          # Trigger the workflow on push to the main branch ( declancheur de workflow)
    push:
        branches:
            [main,master,dev]
          
jobs:
    Test_Unitaire:
        runs-on: ubuntu-latest
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: install dependencies
              run: npm i
            - name: run commande jest
              run: npm run test 
          

    sonarqube-code-quality-scan-job:
        needs: Test_Unitaire
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Source Code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0  # R√©cup√®re tout l'historique pour une analyse compl√®te
                ref: ${{ github.ref }}

               # √âtape 2: Configuration du cache pour npm
            - name: Cache npm dependencies
              uses: actions/cache@v3
              id: npm-cache
              with:
                path: |
                  ~/.npm
                  node_modules
                key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                restore-keys: |
                  ${{ runner.os }}-node-

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '18'
                cache: 'npm'        

            - name: Install dependencies
              run: |
                if [ -f "package-lock.json" ]; then
                  npm ci --no-audit --prefer-offline
                else
                  npm install --no-audit --prefer-offline
                fi
            
            - name: SonarQube Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                # Chemin vers le rapport de couverture (adaptez selon votre outil de test)
                SONAR_COVERAGE_REPORT_PATHS: coverage/lcov.info
                # Exclusion de dossiers inutiles
                SONAR_EXCLUSIONS: '**/node_modules/**,**/*.test.js,**/*.spec.js'
                # Inclusion des fichiers sources
                SONAR_INCLUSIONS: 'src/**/*.js,src/**/*.jsx,src/**/*.ts,src/**/*.tsx'   

            # √âtape 8: V√©rification de la qualit√© (optionnelle)
          #  - name: Quality Gate Check (Non bloquant)
          #    uses: sonarsource/sonarqube-quality-gate-action@master
          #    timeout-minutes: 5
          #    continue-on-error: true  # <-- Permet au pipeline de continuer m√™me si √©chec
          #    env:
          #      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          #
          #  - name: Display Quality Gate Status
          #    if: always()
          #    run: |
          #      echo "‚ö†Ô∏è Note: Quality Gate a √©chou√© mais le pipeline continue."
          #      echo "üìä Pour am√©liorer la qualit√©, corrigez les probl√®mes list√©s dans SonarQube."
  
            # √âtape 9: Upload des artefacts de couverture (optionnel)
            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()                             
              with:
                name: coverage-report
                path: coverage/
                retention-days: 7



    trivy-image-security-scan-job:
      runs-on: ubuntu-latest
      needs: [Test_Unitaire]
      steps:      
        - name: Checkout Code
          uses: actions/checkout@v4
        - name: Install dependencies for Trivy
          run: sudo apt-get update && sudo apt-get install -y curl
        - name: Download and install Trivy
          run: |
            curl -sSL https://github.com/aquasecurity/trivy/releases/download/v0.29.0/trivy_0.29.0_Linux-64bit.tar.gz -o trivy.tar.gz
            tar xzvf trivy.tar.gz
            sudo mv trivy /usr/local/bin/
            trivy --version
        - name: Run Trivy Docker image vulnerability scan
          run: |
            docker build -t ${{ env.IMAGE_NAME }} .
            trivy image ${{ env.IMAGE_NAME }}
                                             



    Build_and_push:
        runs-on: ubuntu-latest
        needs: [Test_Unitaire, sonarqube-code-quality-scan-job, trivy-image-security-scan-job]
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: build docker image
              run: docker build -t  ${{env.IMAGE_NAME}} ${{env.BACKEND_PATH_ARGS}} .  
            - name : tag image #rename image 
              run: docker tag ${{env.IMAGE_NAME}} ${{env.IMAGE_NAME}}:v${{ github.run_number }}
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
               username: ${{ vars.DOCKERHUB_USERNAME }}
               password: ${{ secrets.DOCKERHUB_TOKEN_FRONTEND }}
            - name : list image 
              run : docker images 

            - name : docker push 
              run : docker push ${{env.IMAGE_NAME}}:v${{ github.run_number }}   
  #  Deployment:
  #    runs-on: ubuntu-latest 
  #    needs: [Test_Unitaire , Build_and_push]
  #    steps:
  #      - name: SSH Connect And Deploy
  #        uses: appleboy/ssh-action@v1
  #        with:
  #          host: ${{ secrets.VPS_HOST }}
  #          username: ${{ secrets.VPS_USERNAME }}
  #          password: ${{ secrets.VPS_PASSWORD }}
  #          script: |
  #            cd ${{env.DOCKER_COMPOSE_FILE_PATH}}
  #            sudo docker compose pull ${{env.SERVICE_NAME_FRONTEND}}
  #            sudo docker compose down ${{env.SERVICE_NAME_FRONTEND}}
  #            sudo docker compose up -d         


   
