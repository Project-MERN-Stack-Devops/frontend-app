name: Deploy Frontend 

env:
 BACKEND_PATH_ARGS: --build-arg VITE_API_URL=https://api.33.lebondeveloppeur.net
 IMAGE_NAME:  adeem07/app-session14
 DOCKER_COMPOSE_FILE_PATH : /home/user/devops-script/frontend/dev 
 SERVICE_NAME_FRONTEND : frontend-app 
on:          # Trigger the workflow on push to the main branch ( declancheur de workflow)
    push:
        branches:
            [main,master,dev]
          
jobs:
    Test_Unitaire:
        runs-on: ubuntu-latest
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: install dependencies
              run: npm i
            - name: run commande jest
              run: npm run test 


    Build_and_push:
        runs-on: ubuntu-latest
        needs: Test_Unitaire
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: build docker image
              run: docker build -t  ${{env.IMAGE_NAME}} ${{env.BACKEND_PATH_ARGS}} .  
            - name : tag image #rename image 
              run: docker tag ${{env.IMAGE_NAME}} ${{env.IMAGE_NAME}}:v${{ github.run_number }}
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
               username: ${{ vars.DOCKERHUB_USERNAME }}
               password: ${{ secrets.DOCKERHUB_TOKEN_FRONTEND }}
            - name : list image 
              run : docker images 

            - name : docker push 
              run : docker push ${{env.IMAGE_NAME}}:v${{ github.run_number }}   
    Deployment:
      runs-on: ubuntu-latest 
      needs: [Test_Unitaire , Build_and_push]
      steps:
        - name: SSH Connect And Deploy
          uses: appleboy/ssh-action@v1
          with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USERNAME }}
            password: ${{ secrets.VPS_PASSWORD }}
            script: |
              cd ${{env.DOCKER_COMPOSE_FILE_PATH}}
              sudo docker compose pull ${{env.SERVICE_NAME_FRONTEND}}
              sudo docker compose down ${{env.SERVICE_NAME_FRONTEND}}
              sudo docker compose up -d        



