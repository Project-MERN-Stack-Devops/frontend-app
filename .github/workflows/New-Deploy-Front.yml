name: Deploy Frontend 

env:
 BACKEND_PATH_ARGS: --build-arg VITE_API_URL=https://api.33.lebondeveloppeur.net
 IMAGE_NAME:  adeem07/app-session14
 DOCKER_COMPOSE_FILE_PATH : /home/user/devops-script/frontend/dev 
 SERVICE_NAME_FRONTEND : frontend-app 
on:          # Trigger the workflow on push to the main branch ( declancheur de workflow)
    push:
        branches:
            [main,master,dev]

# Notification de d√©but de pipeline (s'ex√©cute avant tous les jobs)
jobs:
    start_pipeline:
      runs-on: ubuntu-latest
      steps:
        - name: Calculate short SHA
          id: sha
          run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        - name: üîî Notification Slack - D√©but de Pipeline
          uses: slackapi/slack-github-action@v2.1.1
          with:
            webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
            webhook-type: incoming-webhook
            payload: |
              text: |
                üöÄ *D√âBUT PIPELINE FRONTEND - CI/CD* 
                *Repository:* ${{ github.repository }}
                *Branche:* ${{ github.ref_name }}
                *Commit:* ${{ steps.sha.outputs.SHORT_SHA }}
                *Auteur:* ${{ github.actor }}
                *Lien:* ${{ github.event.pull_request.html_url || github.event.head_commit.url }}
                *Pipeline:* #${{ github.run_number }}
                
                üìã *Jobs planifi√©s:*
                ‚Ä¢ Tests Unitaires
                ‚Ä¢ Analyse SonarQube
                ‚Ä¢ Scan S√©curit√© Trivy
                ‚Ä¢ Scan S√©curit√© Snyk
                ‚Ä¢ Build & Push Docker
                
                ‚è±Ô∏è *D√©marrage:* $(date -u '+%H:%M UTC')
          
    Test_Unitaire:
        runs-on: ubuntu-latest
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: install dependencies
              run: npm i
            - name: run commande jest
              run: npm run test 
        
            - name: Calculate short SHA
              id: sha
              run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        
            # Notification en cas d'√©chec uniquement
            - name: üîî Notification Slack - √âchec du Job
              if: failure()
              uses: slackapi/slack-github-action@v2.1.1
              with:
                webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
                webhook-type: incoming-webhook
                payload: |
                  text: |
                    ‚ùå *√âCHEC - Tests Unitaires*
                    *Pipeline:* #${{ github.run_number }}
                    *Job:* Test_Unitaire
                    *Repository:* ${{ github.repository }}
                    *Branche:* ${{ github.ref_name }}
                    *Commit:* ${{ steps.sha.outputs.SHORT_SHA }}
                    
                    *Action requise:* 
                    ‚Ä¢ V√©rifier les logs du job
                    ‚Ä¢ Corriger les tests unitaires
                    ‚Ä¢ Relancer la pipeline si n√©cessaire
                    
                    *Lien vers les logs:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    sonarqube-code-quality-scan-job:
        needs: Test_Unitaire
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Source Code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0  # R√©cup√®re tout l'historique pour une analyse compl√®te
                ref: ${{ github.ref }}

               # √âtape 2: Configuration du cache pour npm
            - name: Cache npm dependencies
              uses: actions/cache@v3
              id: npm-cache
              with:
                path: |
                  ~/.npm
                  node_modules
                key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                restore-keys: |
                  ${{ runner.os }}-node-

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '18'
                cache: 'npm'        

            - name: Install dependencies
              run: |
                if [ -f "package-lock.json" ]; then
                  npm ci --no-audit --prefer-offline
                else
                  npm install --no-audit --prefer-offline
                fi
            
            - name: SonarQube Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                # Chemin vers le rapport de couverture (adaptez selon votre outil de test)
                SONAR_COVERAGE_REPORT_PATHS: coverage/lcov.info
                # Exclusion de dossiers inutiles
                SONAR_EXCLUSIONS: '**/node_modules/**,**/*.test.js,**/*.spec.js'
                # Inclusion des fichiers sources
                SONAR_INCLUSIONS: 'src/**/*.js,src/**/*.jsx,src/**/*.ts,src/**/*.tsx'   

            # √âtape 8: V√©rification de la qualit√© (optionnelle)
          #  - name: Quality Gate Check (Non bloquant)
          #    uses: sonarsource/sonarqube-quality-gate-action@master
          #    timeout-minutes: 5
          #    continue-on-error: true  # <-- Permet au pipeline de continuer m√™me si √©chec
          #    env:
          #      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          #
          #  - name: Display Quality Gate Status
          #    if: always()
          #    run: |
          #      echo "‚ö†Ô∏è Note: Quality Gate a √©chou√© mais le pipeline continue."
          #      echo "üìä Pour am√©liorer la qualit√©, corrigez les probl√®mes list√©s dans SonarQube."
  
            # √âtape 9: Upload des artefacts de couverture (optionnel)
            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              if: always()                             
              with:
                name: coverage-report
                path: coverage/
                retention-days: 7
        
            # Notification en cas d'√©chec uniquement
            - name: üîî Notification Slack - √âchec du Job
              if: failure()
              uses: slackapi/slack-github-action@v2.1.1
              with:
                webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
                webhook-type: incoming-webhook
                payload: |
                  text: |
                    ‚ùå *√âCHEC - Analyse SonarQube*
                    *Pipeline:* #${{ github.run_number }}
                    *Job:* sonarqube-code-quality-scan-job
                    *Repository:* ${{ github.repository }}
                    
                    *Probl√®mes d√©tect√©s:*
                    ‚Ä¢ Analyse qualit√© du code √©chou√©e
                    ‚Ä¢ V√©rifier les m√©triques SonarQube
                    
                    *Action requise:*
                    ‚Ä¢ Consulter le dashboard SonarQube
                    ‚Ä¢ Corriger les probl√®mes de qualit√©
                    ‚Ä¢ Relancer l'analyse apr√®s corrections
                    
                    *Liens utiles:*
                    ‚Ä¢ Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
                    ‚Ä¢ SonarQube: ${{ secrets.SONAR_HOST_URL }}



    trivy-image-security-scan-job:
      runs-on: ubuntu-latest
      needs: [Test_Unitaire]
      steps:      
        - name: Checkout Code
          uses: actions/checkout@v4
        - name: Install dependencies for Trivy
          run: sudo apt-get update && sudo apt-get install -y curl
        - name: Download and install Trivy
          run: |
            curl -sSL https://github.com/aquasecurity/trivy/releases/download/v0.29.0/trivy_0.29.0_Linux-64bit.tar.gz -o trivy.tar.gz
            tar xzvf trivy.tar.gz
            sudo mv trivy /usr/local/bin/
            trivy --version
        - name: Run Trivy Docker image vulnerability scan
          run: |
            docker build -t ${{ env.IMAGE_NAME }} .
            trivy image ${{ env.IMAGE_NAME }}
        
        # Notification en cas d'√©chec uniquement
        - name: üîî Notification Slack - √âchec du Job
          if: failure()
          uses: slackapi/slack-github-action@v2.1.1
          with:
            webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
            webhook-type: incoming-webhook
            payload: |
              text: |
                ‚ùå *√âCHEC - Scan S√©curit√© Trivy*
                *Pipeline:* #${{ github.run_number }}
                *Job:* trivy-image-security-scan-job
                *Repository:* ${{ github.repository }}
                *Image:* ${{ env.IMAGE_NAME }}
                
                *Probl√®mes d√©tect√©s:*
                ‚Ä¢ Vuln√©rabilit√©s critiques trouv√©es
                ‚Ä¢ Scan de s√©curit√© √©chou√©
                
                *Action requise:*
                ‚Ä¢ Examiner les vuln√©rabilit√©s identifi√©es
                ‚Ä¢ Mettre √† jour les d√©pendances vuln√©rables
                ‚Ä¢ Rebuilder l'image apr√®s corrections
                
                *Priorit√©:* HAUTE (S√©curit√©)
                *Lien logs:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}


    snyk-code-security-scan-job:
      runs-on: ubuntu-latest
      needs: [Test_Unitaire]
      permissions:
        security-events: write
        contents: read
      steps:
        - name: Checkout Code
          uses: actions/checkout@v4
        
        - name: Install Snyk
          run: npm install -g snyk 
        
        # ========== D√âBOGAGE : STRUCTURE DU PROJET ==========
        - name: Debug - V√©rifier la structure du projet
          run: |
            echo "=== R√©pertoire courant ==="
            pwd
            echo "=== Liste des fichiers ==="
            ls -la
            echo "=== Recherche des fichiers de d√©pendances ==="
            find . -name "package.json" -o -name "package-lock.json" -o -name "yarn.lock" -o -name "*.csproj" -o -name "pom.xml" -o -name "build.gradle" -o -name "requirements.txt" 2>/dev/null | head -20
            echo "=== V√©rification de Node.js/npm ==="
            node --version || echo "Node.js non install√©"
            npm --version || echo "npm non install√©"
        
        - name: Run Snyk Test and Generate SARIF Report
          id: snyk-scan
          run: |
            echo "=== Ex√©cution de Snyk test (version standard) ==="
            # D'abord, ex√©cuter Snyk en mode normal pour voir ce qu'il trouve
            snyk test --org=ademze --json > snyk-output.json 2>&1 || true
            
            echo "=== Contenu du rapport JSON (premi√®res 10 lignes) ==="
            head -50 snyk-output.json || cat snyk-output.json
            
            echo "=== G√©n√©ration du rapport SARIF ==="
            # Utiliser l'option correcte : --sarif-file-output
            snyk test --sarif --org=ademze --sarif-file-output=snyk-report.sarif
            
            echo "=== V√©rification du fichier g√©n√©r√© ==="
            if [ -f "snyk-report.sarif" ]; then
              echo "‚úÖ Fichier SARIF cr√©√© avec succ√®s"
              echo "Taille : $(wc -l < snyk-report.sarif) lignes"
              echo "=== Aper√ßu du contenu (premi√®res 30 lignes) ==="
              head -30 snyk-report.sarif
            else
              echo "‚ùå √âCHEC : Fichier SARIF NON cr√©√©"
              echo "La commande Snyk a peut-√™tre √©chou√© avant de cr√©er le fichier"
              exit 1
            fi
          env:
            SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          continue-on-error: true
        
        - name: Upload SARIF Report to GitHub Security
          if: success() || failure()  # S'ex√©cute m√™me si les √©tapes pr√©c√©dentes √©chouent
          uses: github/codeql-action/upload-sarif@v4
          with:
            sarif_file: snyk-report.sarif
        
        # Notification en cas d'√©chec uniquement
        - name: üîî Notification Slack - √âchec du Job
          if: failure()
          uses: slackapi/slack-github-action@v2.1.1
          with:
            webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
            webhook-type: incoming-webhook
            payload: |
              text: |
                ‚ùå *√âCHEC - Scan S√©curit√© Snyk*
                *Pipeline:* #${{ github.run_number }}
                *Job:* snyk-code-security-scan-job
                *Repository:* ${{ github.repository }}
                *Organisation:* ademze
                
                *Probl√®mes d√©tect√©s:*
                ‚Ä¢ Vuln√©rabilit√©s dans les d√©pendances
                ‚Ä¢ Scan de s√©curit√© Snyk √©chou√©
                
                *Action requise:*
                ‚Ä¢ Consulter le rapport Snyk
                ‚Ä¢ Mettre √† jour les packages vuln√©rables
                ‚Ä¢ R√©ex√©cuter le scan apr√®s corrections
                
                *Liens utiles:*
                ‚Ä¢ Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
                ‚Ä¢ Dashboard Snyk: https://app.snyk.io/org/ademze
    
    Build_and_push:
        runs-on: ubuntu-latest
        needs: [Test_Unitaire, sonarqube-code-quality-scan-job, trivy-image-security-scan-job ,snyk-code-security-scan-job]
        steps:
            - name: clone code 
              uses: actions/checkout@v5
            - name: build docker image
              run: docker build -t  ${{env.IMAGE_NAME}} ${{env.BACKEND_PATH_ARGS}} .  
            - name : tag image #rename image 
              run: docker tag ${{env.IMAGE_NAME}} ${{env.IMAGE_NAME}}:v${{ github.run_number }}
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
               username: ${{ vars.DOCKERHUB_USERNAME }}
               password: ${{ secrets.DOCKERHUB_TOKEN_FRONTEND }}
            - name : list image 
              run : docker images 

            - name : docker push 
              run : docker push ${{env.IMAGE_NAME}}:v${{ github.run_number }}
        
        # Notification en cas d'√©chec uniquement
            - name: üîî Notification Slack - √âchec du Job
              if: failure()
              uses: slackapi/slack-github-action@v2.1.1
              with:
                webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
                webhook-type: incoming-webhook
                payload: |
                  text: |
                    ‚ùå *√âCHEC - Build & Push Docker*
                    *Pipeline:* #${{ github.run_number }}
                    *Job:* Build_and_push
                    *Repository:* ${{ github.repository }}
                    *Image:* ${{ env.IMAGE_NAME }}:v${{ github.run_number }}
                    
                    *Probl√®mes d√©tect√©s:*
                    ‚Ä¢ √âchec du build Docker
                    ‚Ä¢ √âchec du push vers Docker Hub
                    
                    *Action requise:*
                    ‚Ä¢ V√©rifier le Dockerfile
                    ‚Ä¢ V√©rifier les credentials Docker Hub
                    ‚Ä¢ Corriger les erreurs de build
                    
                    *Priorit√©:* HAUTE (D√©ploiement bloqu√©)
                    *Lien logs:* https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    # Job de rapport final et notification de fin de pipeline
    Pipeline_Report_Final:
      runs-on: ubuntu-latest
      needs: [Test_Unitaire, sonarqube-code-quality-scan-job, trivy-image-security-scan-job, snyk-code-security-scan-job, Build_and_push]
      if: always()  # S'ex√©cute toujours, m√™me si d'autres jobs √©chouent
      
      steps:
        - name: Calculate short SHA
          id: sha
          run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
        - name: üîî Notification Slack - Fin de Pipeline
          uses: slackapi/slack-github-action@v2.1.1
          with:
            webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
            webhook-type: incoming-webhook
            payload: |
              blocks:
                - type: header
                  text:
                    type: plain_text
                    text: "${{ (needs.Test_Unitaire.result == 'success' && needs.sonarqube-code-quality-scan-job.result == 'success' && needs.trivy-image-security-scan-job.result == 'success' && needs.snyk-code-security-scan-job.result == 'success' && needs.Build_and_push.result == 'success') && '‚úÖ PIPELINE TERMIN√âE - SUCC√àS' || '‚ö†Ô∏è PIPELINE TERMIN√âE - √âCHECS' }}"
                - type: section
                  text:
                    type: mrkdwn
                    text: |
                      *üìä RAPPORT FINAL - Pipeline Frontend #${{ github.run_number }}*
                      *Repository:* ${{ github.repository }}
                      *Branche:* ${{ github.ref_name }}
                      *Commit:* ${{ steps.sha.outputs.SHORT_SHA }}
                      *Auteur:* ${{ github.actor }}
                      *Dur√©e totale:* ${{ job.steps.duration }}
                - type: divider
                - type: section
                  text:
                    type: mrkdwn
                    text: |
                      *üìà STATUT DES JOBS:*
                      ```bash
                      Test_Unitaire:                 ${{ needs.Test_Unitaire.result == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
                      SonarQube Scan:                ${{ needs['sonarqube-code-quality-scan-job'].result == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
                      Trivy Security Scan:           ${{ needs['trivy-image-security-scan-job'].result == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
                      Snyk Security Scan:            ${{ needs['snyk-code-security-scan-job'].result == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
                      Build & Push Docker:           ${{ needs.Build_and_push.result == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILURE' }}
                      ```
                - type: section
                  text:
                    type: mrkdwn
                    text: |
                      *üì¶ ARTIFACTS G√âN√âR√âS:*
                      ‚Ä¢ Image Docker: `${{ env.IMAGE_NAME }}:v${{ github.run_number }}`
                      ‚Ä¢ Tag: `v${{ github.run_number }}`
                      ‚Ä¢ Registry: Docker Hub
                      ‚Ä¢ Lien: https://hub.docker.com/r/${{ env.IMAGE_NAME }}
                - type: actions
                  elements:
                    - type: button
                      text:
                        type: plain_text
                        text: "üìã Voir les logs d√©taill√©s"
                      url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      style: "${{ (needs.Test_Unitaire.result == 'success' && needs['sonarqube-code-quality-scan-job'].result == 'success' && needs['triviy-image-security-scan-job'].result == 'success' && needs['snyk-code-security-scan-job'].result == 'success' && needs.Build_and_push.result == 'success') && 'primary' || 'danger' }}"
                    - type: button
                      text:
                        type: plain_text
                        text: "üê≥ Docker Hub"
                      url: "https://hub.docker.com/r/${{ env.IMAGE_NAME }}"
                - type: context
                  elements:
                    - type: mrkdwn
                      text: "üïí Pipeline ex√©cut√©e le: $(date -u '+%Y-%m-%d %H:%M UTC') | ID: ${{ github.run_id }}"
  
  #  Deployment:
  #    runs-on: ubuntu-latest 
  #    needs: [Test_Unitaire , Build_and_push]
  #    steps:
  #      - name: SSH Connect And Deploy
  #        uses: appleboy/ssh-action@v1
  #        with:
  #          host: ${{ secrets.VPS_HOST }}
  #          username: ${{ secrets.VPS_USERNAME }}
  #          password: ${{ secrets.VPS_PASSWORD }}
  #          script: |
  #            cd ${{env.DOCKER_COMPOSE_FILE_PATH}}
  #            sudo docker compose pull ${{env.SERVICE_NAME_FRONTEND}}
  #            sudo docker compose down ${{env.SERVICE_NAME_FRONTEND}}
  #            sudo docker compose up -d